<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>View Ethereum Transactions</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body id="body-pd">
  <!-- HEADER START -->
  <header class="header" id="header">
    <div class="header_toggle"> <i class='bx bx-menu' id="header-toggle"></i> </div>
  </header>
  <!-- HEADER END -->

  <!-- NAVBAR START -->
  <div class="l-navbar" id="nav-bar">
    <nav class="nav nav-tabs" role="tablist" id="nav-tabs">
      <!-- LOGO -->
      <div>
        <div class="logo-dis">
          <a href="index.html">
            <lord-icon src="https://cdn.lordicon.com/zchxlapl.json" trigger="hover" colors="primary:#f7f6fb"
              style="width:25px;height:25px">
            </lord-icon><span class="nav_logo-name">ETH</span>
          </a>
        </div>

        <!-- LIST -->
        <div class="nav_list">
          <!-- HOME -->
          <button class="nav_link active-nav" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-home"
            type="button" role="tab" aria-controls="nav-home" aria-selected="true">
            <lord-icon src="https://cdn.lordicon.com/osuxyevn.json" trigger="hover" class="current-color"
              style="width:20px;height:20px">
            </lord-icon>
            <span class="nav_name">Home</span>
          </button>

          <!-- SEARCH -->
          <button class="nav_link" id="nav-search-tab" data-bs-toggle="tab" data-bs-target="#nav-search" type="button"
            role="tab" aria-controls="nav-search" aria-selected="false">
            <lord-icon src="https://cdn.lordicon.com/rlizirgt.json" trigger="hover" class="current-color"
              style="width:20px;height:20px">
            </lord-icon> <span class="nav_name">Search</span>
          </button>

          <!-- WALLET -->
          <button class="nav_link" id="nav-wallet-tab" data-bs-toggle="tab" data-bs-target="#nav-wallet" type="button"
            role="tab" aria-controls="nav-wallet" aria-selected="false">
            <lord-icon src="https://cdn.lordicon.com/jsoeastu.json" trigger="hover" class="current-color"
              style="width:20px;height:20px">
            </lord-icon>
            <span class="nav_name">Wallet</span>
          </button>

          <!-- TOKENS -->
          <button class="nav_link" id="nav-tokens-tab" data-bs-toggle="tab" data-bs-target="#nav-tokens" type="button"
          role="tab" aria-controls="nav-tokens" aria-selected="false">
          <lord-icon src="https://cdn.lordicon.com/zqxjldws.json" trigger="hover" class="current-color"
            style="width:20px;height:20px">
          </lord-icon>
          <span class="nav_name">Other Tokens</span>
        </button>
        </div>
      </div>
    </nav>
  </div>
  <!-- NAVBAR END -->

  <!--Container Main start-->
  <div class="height-100 finisher-header tab-content" id="nav-tabContent">
    <!-- HOME SECTION -->
    <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
      <div class="hero">
        <h1>ETH CRAWLER TASK</h1>
        <h2>Welcome!</h2>
        <h3>You can search for transactions with addresses or check what amount was available at a certain time.</h3>
        <p>Keep in mind that there is a 10,000 limit per request for transactions as I am using Infura API with a <span class="important">free</span> account.</p>
        <h4><a href="#" id="source"><i class="fa fa-github" aria-hidden="true"></i> Source code</a></h4>
      </div>
    </div>

    <!-- SEARCH SECTION -->
    <div class="tab-pane fade" id="nav-search" role="tabpanel" aria-labelledby="nav-search-tab">
      <h1>View Ethereum Transactions</h1>
      <form action="/transactions" id="transactions">
        <label for="wallet-address">Wallet Address:</label>
        <input type="text" name="walletAddress" id="wallet-address" required />
        <label for="starting-block">Starting Block:</label>
        <input type="number" name="startingBlock" id="starting-block" required />
        <button type="submit">View Transactions</button>
      </form>
      <div class="spinner-border hide-load" role="status" id="loader">
      </div>
      <div id="result-transactions" class="container-fluid">
      </div>
    </div>

    <!-- WALLET SECTION -->
    <div class="tab-pane fade" id="nav-wallet" role="tabpanel" aria-labelledby="nav-wallet-tab">
      <h1>Check Balance At Given Time</h1>
      <form action="/balance" id="balance">
        <label for="wallet-address">Wallet Address:</label>
        <input type="text" name="walletAddressBalance" id="wallet-address-balance" required />
        <label for="date-input">Date:</label>
        <input type="date" id="date-input" name="date">
        <button type="submit">Check Balance</button>
      </form>
      <div class="spinner-border hide-load" role="status" id="loader-balance">
      </div>
      <div id="result-balance" class="container"></div>
    </div>

    <!-- OTHER TOKENS SECTION -->
    <div class="tab-pane fade" id="nav-tokens" role="tabpanel" aria-labelledby="nav-tokens-tab">
      <h1>Check Tokens At Given Time</h1>
      <form action="/tokens" id="tokens">
        <label for="wallet-address-token">Wallet Address:</label>
        <input type="text" name="walletAddresstokens" id="wallet-address-tokens" required />
        <label for="token-address">Tokens Address:</label>
        <input type="text" name="tokensAddress" id="token-address" required />
        <label for="date-input-tokens">Date:</label>
        <input type="date" id="date-input-tokens" name="date">
        <button type="submit">Check Tokens</button>
      </form>
      <div class="spinner-border hide-load" role="status" id="loader-tokens">
      </div>
      <div id="result-tokens" class="container"></div>
    </div>
    <!--Container Main end-->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="finisher-header.es5.min.js" type="text/javascript"></script>
  <script src="https://cdn.lordicon.com/ritcuqlt.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script>
    const formTransactions = document.getElementById('transactions');
    const resultDivTransactions = document.getElementById('result-transactions');
    
    const formBalance = document.getElementById('balance');
    const resultDivBalance = document.getElementById('result-balance');

    const formTokens = document.getElementById('tokens');
    const resultDivTokens = document.getElementById('result-tokens');

    formBalance.addEventListener('submit', async (event) => {
      event.preventDefault();
      const address = $("#wallet-address-balance").val();
      const date = $("#date-input").val();
      $("#loader-balance").removeClass('hide-load');
      const formData = new FormData(formBalance);
      $("#wallet-address-balance").val();
      $("#date-input").val();
      const response = await fetch(`balance?address=${address}&date=${date}`, {
        method: 'get',
      });
      let show;
      if (response.ok) {
        let balance = await response.json();
        show = `
        <h4>Account: ${address}</h4>
        <h4>Date: ${date}</h4>
        <h4>Balance: ${balance} ETH</h4>
        `
      } else {
        show = `
        <h2>Looks like your request didn't pass through. Please check that you entered valid address and try again.</h2>
        `
      }
      $('#loader-balance').addClass('hide-load');
      resultDivBalance.innerHTML = show;
    });

    formTokens.addEventListener('submit', async (event) => {
      event.preventDefault();
      const address = $("#tokens-address").val();
      const date = $("#date-input-tokens").val();
      const token = $("#token-address").val();
      $("#loader-tokens").removeClass('hide-load');
      const formData = new FormData(formTokens);
      $("#tokens-address").val();
      $("#date-input-tokens").val();
      const response = await fetch(`tokens?address=${address}&date=${date}&token=${token}`, {
        method: 'get',
      });
      let show;
      if (response.ok) {
        let tokens = await response.json();
        show = `
        <h4>Account: ${address}</h4>
        <h4>Date: ${date}</h4>
        <h4>tokens: ${tokens} ETH</h4>
        `
      } else {
        show = `
        <h2>Looks like your request didn't pass through. Please check that you entered valid address and try again.</h2>
        `
      }
      $('#loader-tokens').addClass('hide-load');
      resultDivTokens.innerHTML = show;
    });

    formTransactions.addEventListener('submit', async (event) => {
      event.preventDefault();
      const testA = $("#wallet-address").val();
      const testB = $("#starting-block").val();
      $("#loader").removeClass('hide-load');
      const formData = new FormData(formTransactions);
      const response = await fetch(`transactions?wallet=${testA}&block=${testB}`, {
        method: 'get',
      });
      let table;
      if (response.ok) {
        table = `
      <div class="row">
        <div class="col-md-offset-1 col-md-10">
            <div class="panel">
                <div class="panel-body table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>FROM</th>
                                <th>TO</th>
                                <th>AMOUNT</th>
                            </tr>
                        </thead>
                        <tbody id="table-result"></tbody>
                    </table>
                  </div>
              </div>
            </div>
          </div>
      `;
      } else {
        table = `
        <div class="error">
          <h1>Block Range Error</h1>
          <h2>Query returned more than 10000 results. Please try with again with smaller block range</h2>
        </div>`;
        $('#loader').addClass('hide-load');
      }
      resultDivTransactions.innerHTML = table;
      const resultTable = document.getElementById('table-result');
      const result = await response.json();
      const resultHtml = result
        .map(
          (transaction) => `
                <tr>
                    <td>${transaction.from}</td>
                    <td>${transaction.to}</td>
                    <td>${transaction.valueEth} ETH</td>
                </tr>
          `
        )
        .join('');
      $('#loader').addClass('hide-load');
      resultTable.innerHTML = resultHtml;
      $('table').DataTable({
        scrollY: false,
        info: false,
      });
      $("#wallet-address").val('');
      $("#starting-block").val('');
    });
  </script>
  <script src="index-script.js"></script>
</body>

</html>